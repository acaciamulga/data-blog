---
title: Common things to look out for when post-processing GBIF downloads
author: John Waller
date: '2021-02-17'
slug: gbif-filtering-guide
categories:
  - GBIF
tags: []
lastmod: '2020-12-08T09:51:20+01:00'
draft: no
keywords: []
description: ''
authors: ''
comment: no
toc: ''
autoCollapseToc: no
postMetaInFooter: no
hiddenFromHomePage: no
contentCopyright: no
reward: no
mathjax: no
mathjaxEnableSingleDollar: no
mathjaxEnableAutoNumber: no
hideHeaderAndFooter: no
flowchartDiagrams:
  enable: no
  options: ''
sequenceDiagrams:
  enable: no
  options: ''
---



<p>Here I present a <strong>checklist</strong> for filtering <strong>GBIF downloads</strong>.</p>
<p>In this guide, I will assume you are <strong>familar with R</strong>. This guide is also somewhat general, <strong>so your solution might differ</strong>.
This guide is intended to give you a checklist of <strong>common things to look out for</strong> when post-processing GBIF downloads.</p>
<!--more-->
<!-- ## The checklist :  -->
<!-- - check **default geospatial issues** -->
<!-- - check **occurrenceStatus** -->
<!-- - check **basisOfRecord** ("FOSSIL_SPECIMEN" "LIVING_SPECIMEN")  -->
<!-- - check **establishmentMeans** ("MANAGED", "INTRODUCED", "INVASIVE", "NATURALISED") -->
<!-- - check **event date** or year -->
<!-- - check **uncertainty** (coordinatePrecision, coordinateUncertaintyInMeters) -->
<!-- - check if **zero coordinates** (decimalLatitude=0 or decimallongitude= 0) -->
<!-- - check if **country centroid** or other centroid -->
<!-- - check if in **ocean** -->
<!-- - check for **location duplicates**  -->
<p>Here is an example a <strong>filtering checklist script</strong> that would work for most users. Indvidual users might want to <strong>add/remove</strong> some steps.</p>
<p>After the script, I discuss each of these steps in <strong>more detail below</strong>.
You can get the <code>Calopteryx xanthostoma.csv</code> csv file here: <a href="/post/2020-12-08-typical-user-gbif-data-cleaning_files/Calopteryx%20xanthostoma.csv">gbif_download</a>.</p>
<pre class="r"><code>library(dplyr)
library(CoordinateCleaner)

gbif_download = readr::read_tsv(&quot;Calopteryx xanthostoma.csv&quot;)

gbif_download %&gt;%
setNames(tolower(names(.))) %&gt;% # set lowercase column names to work with CoordinateCleaner
filter(occurrencestatus  == &quot;PRESENT&quot;) %&gt;%
filter(!is.na(decimallongitude)) %&gt;% 
filter(!is.na(decimallatitude)) %&gt;% 
filter(!basisofrecord %in% c(&quot;FOSSIL_SPECIMEN&quot;,&quot;LIVING_SPECIMEN&quot;)) %&gt;%
filter(!establishmentmeans %in% c(&quot;MANAGED&quot;, &quot;INTRODUCED&quot;, &quot;INVASIVE&quot;, &quot;NATURALISED&quot;)) %&gt;%
filter(year &gt;= 1900) %&gt;% 
filter(coordinateprecision &gt; 0.01 | is.na(coordinateprecision)) %&gt;% 
filter(coordinateuncertaintyinmeters &lt; 10000 | is.na(coordinateuncertaintyinmeters)) %&gt;%
filter(!coordinateuncertaintyinmeters %in% c(301,3036,999,9999)) %&gt;% 
filter(!decimallatitude == 0 | !decimallongitude == 0) %&gt;%
cc_cen(buffer = 2000) %&gt;% # remove country centroids within 2km 
cc_cap(buffer = 2000) %&gt;% # remove capitals centroids within 2km
cc_inst(buffer = 2000) %&gt;% # remove zoo and herbaria within 2km 
cc_sea() %&gt;% # remove from ocean 
distinct(decimallongitude,decimallatitude,specieskey,datasetkey, .keep_all = TRUE) %&gt;%
glimpse() # look at results of pipeline</code></pre>
<p>It is usually a good idea to move as much of your data filtering into the <strong>download stage</strong> as possible. Some filters I list above are <strong>not available</strong> at the download stage.</p>
<p>Here a script that moves <strong>most</strong> filters from above into the <strong>downloads api</strong>.</p>
<pre class="r"><code>library(rgbif)

user=&quot;&quot; # GBIF user name
pwd=&quot;&quot; # GBIF password
email=&quot;&quot; # your email

gbif_download = occ_download(
type=&quot;and&quot;,
pred(&quot;taxonKey&quot;, 5052020), # Calopteryx xanthostoma 
pred(&quot;hasGeospatialIssue&quot;, FALSE),
pred(&quot;hasCoordinate&quot;, TRUE),
pred_gte(&quot;year&quot;, 1900),
pred_not(pred(&quot;basisOfRecord&quot;, &quot;FOSSIL_SPECIMEN&quot;)),
pred_not(pred(&quot;basisOfRecord&quot;, &quot;LIVING_SPECIMEN&quot;)),
pred_not(pred(&quot;establishmentMeans&quot;,&quot;MANAGED&quot;)),
pred_not(pred(&quot;establishmentMeans&quot;,&quot;INTRODUCED&quot;)),
pred_not(pred(&quot;establishmentMeans&quot;,&quot;INVASIVE&quot;)),
pred_not(pred(&quot;establishmentMeans&quot;,&quot;NATURALISED&quot;)),
pred_or(
pred_lt(&quot;coordinateUncertaintyInMeters&quot;,10000),
pred_not(pred_notnull(&quot;coordinateUncertaintyInMeters&quot;)) # keep null values
),
format = &quot;SIMPLE_CSV&quot;,
user=user,pwd=pwd,email=email
)

# rest of the pipeline after download
# not yet possible to use these filters in the download stage 

gbif_download %&gt;%
filter(coordinateprecision &gt; 0.01 | is.na(coordinateprecision)) %&gt;% 
filter(!coordinateuncertaintyinmeters %in% c(301,3036,999,9999)) %&gt;% 
filter(!decimallatitude == 0 | !decimallongitude == 0) %&gt;%
cc_cen(buffer = 2000) %&gt;% # remove country centroids within 2km 
cc_cap(buffer = 2000) %&gt;% # remove capitals centroids within 2km
cc_inst(buffer = 2000) %&gt;% # remove zoo and herbaria within 2km 
cc_sea() %&gt;% # remove from ocean 
distinct(decimallongitude,decimallatitude,specieskey,datasetkey, .keep_all = TRUE) %&gt;%
glimpse() # look at results of pipeline
</code></pre>
<div id="gbif-default-geospatial-issues" class="section level2">
<h2>GBIF default geospatial issues</h2>
<p>GBIF removes <strong>common geospatial issues</strong> by default if you choose to have data with a location.</p>
<p>The following things will be removed:</p>
<ol style="list-style-type: decimal">
<li><strong>Zero coordinate</strong> : Coordinates are exactly (0,0). <a href="https://en.wikipedia.org/wiki/Null_Island">null island</a></li>
<li><strong>Country coordinate mismatch</strong> : The coordinates fall outside of the given country’s polygon.</li>
<li><strong>Coordinate invalid</strong> : GBIF is unable to interpret the coordiantes.</li>
<li><strong>Coordinate out of range</strong> : The coordinates are outside of the range for decimal lat/lon values ((-90,90), (-180,180)).</li>
</ol>
<p>You can do this on the <a href="https://www.gbif.org/occurrence/search?has_coordinate=true&amp;has_geospatial_issue=false&amp;occurrence_status=present">web portal</a> before downloading or in <code>rgbif</code>.</p>
<pre class="r"><code>library(rgbif)

# Calopteryx xanthostoma Charpentier, 1825
gbif_download = occ_download(
pred_in(&quot;taxonKey&quot;, 1427020), 
format = &quot;SIMPLE_CSV&quot;,
hasGeospatialIssue = FALSE,
hasCoordinate = TRUE,
user=&quot;&quot;,pwd=&quot;&quot;,email=&quot;&quot;
)
</code></pre>
</div>
<div id="absence-data" class="section level2">
<h2>Absence data</h2>
<p>GBIF now has a field called <strong>occurrence status</strong>, which will tell you whether an occurrence is a presence or absence.</p>
<pre class="r"><code>gbif_download %&gt;%
filter(occurrenceStatus  == “PRESENT”)</code></pre>
<p>You can also do this on the <a href="https://www.gbif.org/occurrence/search?occurrence_status=present&amp;q=">web portal</a> before downloading.</p>
</div>
<div id="fossils-living-specimens-and-established-by-humans" class="section level2">
<h2>Fossils, living specimens, and established by humans</h2>
<p>You might want to remove <strong>fossils</strong> and <strong>living specimens</strong>, and <strong>non-naturally established species</strong>.</p>
<pre class="r"><code>gbif_download %&gt;% 
filter(!basisOfRecord %in% c(&quot;FOSSIL_SPECIMEN&quot;,&quot;LIVING_SPECIMEN&quot;)) %&gt;%
filter(!establishmentMeans %in% c(&quot;MANAGED&quot;, &quot;INTRODUCED&quot;, &quot;INVASIVE&quot;, &quot;NATURALISED&quot;))</code></pre>
<p>Often zoos and botanical gardens will fill in the <strong>establishmentMeans</strong> column with managed.</p>
</div>
<div id="old-records" class="section level2">
<h2>Old records</h2>
<p>You might also want to remove old records.</p>
<pre class="r"><code>gbif_download %&gt;% 
filter(year &gt;= 1900)</code></pre>
<p>You can also do this on the <a href="https://www.gbif.org/occurrence/search?year=1900,2020&amp;occurrence_status=present">web portal</a> before downloading.</p>
</div>
<div id="high-uncertainty" class="section level2">
<h2>High uncertainty</h2>
<p>There are two fields that come with <strong>simple csv downloads</strong> that give uncertainty.</p>
<ol style="list-style-type: decimal">
<li><strong>coordinatePrecision</strong> : A decimal representation of the precision of the coordinates.</li>
<li><strong>coordinateUncertaintyInMeters</strong> : the uncertainty of the coordinates in meters.</li>
</ol>
<p>These fields are not frequently used by publishers (around 600M occurrences do not fill in either), <strong>so filter with caution</strong>. I have kept missing values in my example.</p>
<p>If you want to be sure that a point has the acceptable level of uncertainty or precision for your study, you can remove those with missing values, but this will be removing a lot “ok” records.</p>
<pre class="r"><code># I keep missing values here
gbif_download %&gt;% 
filter(
coordinatePrecision &gt; 0.01 | is.na(coordinatePrecision)
) %&gt;% 
filter(
coordinateUncertaintyInMeters &lt; 1000 | is.na(coordinateUncertaintyInMeters)
) 
</code></pre>
<p>You also want to remove records with <a href="https://github.com/ropensci/CoordinateCleaner/issues/55">known default values</a> for <strong>coordinateUncertaintyInMeters</strong>. These can be <strong>GeoLocate centroids</strong> or some other default. It is good to remove them because usually the uncertainy is larger than what is stated by the value.</p>
<pre class="r"><code>gbif_download %&gt;% 
filter(!coordinateUncertaintyInMeters %in% c(301,3036,999,9999)) 
# known inaccurate default values
</code></pre>
</div>
<div id="points-along-equator-or-prime-merdidian" class="section level2">
<h2>Points along equator or prime merdidian</h2>
<p>Point plotted along the <strong>prime meridian</strong> or <strong>equator</strong>.</p>
<p>As of the writing of this guide there are 37K occurrences along the <strong>equator</strong> and 28K along the <strong>Prime meridian</strong>.</p>
<pre class="r"><code>gbif_download %&gt;% 
filter(decimalLatitude == 0 | decimalLongitude == 0)

# see also CoordinateCleaner::cc_zero()</code></pre>
</div>
<div id="country-centroids" class="section level2">
<h2>Country centroids</h2>
<p>You can remove country centroids and province centroids using <strong>CoordinateCleaner</strong>.</p>
<pre class="r"><code>library(CoordinateCleaner)

gbif_download %&gt;% 
cc_cen(
lon = &quot;decimalLongitude&quot;, 
lat = &quot;decimalLatitude&quot;, 
buffer = 2000, # radius of circle around centroid to look for centroids
value = &quot;clean&quot;,
test=&quot;both&quot;)  </code></pre>
<p>Centroids tend to be more common for geocoded museum collections (PRESERVED_SPECIMEN), so you might want to only filter centroids for preserved specimens, since other occurrences might be false positives.</p>
<p>You might also want to filter <strong>country capitals</strong>.</p>
<pre class="r"><code>gbif_download %&gt;% 
cc_cap(
lon = &quot;decimalLongitude&quot;, 
lat = &quot;decimalLatitude&quot;, 
buffer = 2000, # radius of circle around centroid to look for centroids
value = &quot;clean&quot;)
</code></pre>
</div>
<div id="zoo-and-herbaria-locations" class="section level2">
<h2>Zoo and herbaria locations</h2>
<p>Publishers do not always fill in the establishmentMeans=“MANAGED” or basisOfRecord=“LIVING_SPECIMEN”, so it is usually good to filter known <strong>zoo</strong> and <strong>herbaria</strong> locations.</p>
<pre class="r"><code>library(CoordinateCleaner)

gbif_download %&gt;% 
cc_inst(
lon = &quot;decimalLongitude&quot;,
lat = &quot;decimalLatitude&quot;,
buffer = 2000,
value = &quot;clean&quot;,
verbose = TRUE
)
</code></pre>
</div>
<div id="in-the-ocean" class="section level2">
<h2>In the ocean</h2>
<p>Obviously not to be used with marine species. If marine, you might want to do the opposite.</p>
<pre class="r"><code>library(CoordinateCleaner)

gbif_download %&gt;% 
cc_sea(
lon = &quot;decimalLongitude&quot;,
lat = &quot;decimalLatitude&quot;
)
</code></pre>
</div>
<div id="location-duplicates" class="section level2">
<h2>Location duplicates</h2>
<p>Some of you will want to remove potential <strong>location duplicates</strong>.</p>
<pre class="r"><code>gbif_download %&gt;% 
distinct(decimalLongitude,decimalLatitude,speciesKey,datasetKey, .keep_all = TRUE) </code></pre>
<p>It is probably a good idea to keep the <strong>datasetKey</strong> for citing the download later, if you post a derived dataset on Zenodo or something similar.</p>
<p>In general removing duplicates is not difficult based on location. GBIF also has a experimental feature for indentifying <a href="https://www.gbif.org/news/4U1dz8LygQvqIywiRIRpAU/new-data-clustering-feature-aims-to-improve-data-quality-and-reveal-cross-dataset-connections">related records</a>. It is, however, not optimized for data filtering yet.</p>
</div>
<div id="r-packages-for-filtering-data" class="section level2">
<h2>R packages for filtering data</h2>
<p>There are currently 3 <strong>R packages</strong> for filtering GBIF occurrences:</p>
<ol style="list-style-type: decimal">
<li><a href="https://github.com/ropensci/CoordinateCleaner">CoordinateCleaner</a></li>
<li><a href="https://cran.r-project.org/web/packages/biogeo/index.html">biogeo</a></li>
<li><a href="https://github.com/ropensci/scrubr">scrubr</a></li>
</ol>
<p><strong>CoordinateCleaner</strong> is probably the most <a href="https://cran.r-project.org/web/packages/CoordinateCleaner/vignettes/Comparison_other_software.html">most complete</a>.</p>
</div>
<div id="additional-filters" class="section level2">
<h2>Additional filters</h2>
<p>There are some <strong>additional</strong> things you might want to check for which invovle more judgement calls:</p>
<ul>
<li>outliers<br />
</li>
<li>metagenomics</li>
<li>outside native ranges</li>
<li>gridded datasets</li>
<li>automate identifications</li>
</ul>
<p>I have written some companion R scripts for handling these issues as well <a href="https://github.com/jhnwllr/GBIF_additional_filters/blob/main/README.md">link to scripts</a>.</p>
</div>
